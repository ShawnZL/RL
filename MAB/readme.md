```python
self.estimates[k] += 1. / (self.counts[k] + 1) * (r - self.estimates[k])
```

这行代码更新了 `self.estimates[k]`，即关于被选择的臂 \( k \) 的期望奖励估计值。我们可以将其分解为几个部分来理解：

1. **`1. / (self.counts[k] + 1)`**
   - `self.counts[k]` 是一个计数器，记录臂 \( k \) 被选择的次数。
   - `self.counts[k] + 1` 是为了包括当前这次选择。
   - `1. / (self.counts[k] + 1)` 计算的是新观察到的奖励应该在总体估计中占的权重。随着选择次数的增加，这个权重会逐渐减小，这种方法类似于增量平均法。
   
2. **`(r - self.estimates[k])`**

   - `r` 是通过选择臂 \( k \) 后得到的实际奖励。
   - `self.estimates[k]` 是当前对臂 \( k \) 的奖励估计。
   - `(r - self.estimates[k])` 是一个误差项，表示实际奖励与当前估计之间的差距。

3. **`self.estimates[k] += ...`**

   - 这部分代码实现了对 `self.estimates[k]` 的更新。
   - `self.estimates[k] += 1. / (self.counts[k] + 1) * (r - self.estimates[k])` 使用步长 `1. / (self.counts[k] + 1)` 来调整 `self.estimates[k]`，使其更接近于新的观测值 `r`。
   - 该公式是增量形式的平均更新方法，逐步更新平均值，使其随着每次新观测值的到来而调整。

```
新的估计=旧的估计+学习率×(奖励−旧的估计)
```

这段代码在每次选择臂后更新对该臂的奖励估计值，使其逐渐收敛于真实的期望奖励。通过这种方式，算法可以在不需要存储所有历史奖励的情况下有效地跟踪奖励的变化。



```
self._a[k] += r
self._b[k] -= (1 - r)
```

在这段代码中，`self._a` 和 `self._b` 是用于跟踪每个臂的奖励结果的两个参数数组。它们用于更新 Beta 分布的参数，以反映每个臂在过去试验中的表现。这是 Thompson Sampling 算法的一部分，该算法用于解决多臂老虎机问题。

具体来说：

1. **`self._a[k] += r`**

   - `self._a` 是一个包含每个臂奖励为 1 的次数的数组。
   - `r` 是从 `self.bandit.step(k)` 中获得的奖励，它通常是二值的（0 或 1）。
   - 当 `r` 为 1 时，表示选择的臂 \( k \) 获得了奖励，因此 `self._a[k]` 增加 1。
   - 这相当于记录该臂出现奖励 1 的次数，用于更新 Beta 分布的第一个参数。

2. **`self._b[k] += (1 - r)`**

   - `self._b` 是一个包含每个臂奖励为 0 的次数的数组。
   - `1 - r` 计算的是未获得奖励的情况（因为 `r` 只会是 0 或 1）。
   - 当 `r` 为 0 时，表示选择的臂 \( k \) 没有获得奖励，因此 `self._b[k]` 增加 1。
   - 这相当于记录该臂出现奖励 0 的次数，用于更新 Beta 分布的第二个参数。

通过更新这两个参数，Thompson Sampling 算法可以在每次观察到新的奖励结果后，调整对每个臂的奖励分布的估计。这种调整使得算法能够在不确定性较大的情况下，更灵活地选择臂，从而在长时间内优化总奖励。





```
samples = np.random.beta(self._a, self._b)
```

`np.random.beta(self._a, self._b)` 是 NumPy 库中用于从 Beta 分布中生成随机样本的函数。Beta 分布是一种定义在 (0, 1) 区间上的连续概率分布，广泛用于贝叶斯统计和概率建模，特别是在处理概率和比例的问题时。

### 具体解释：
- **`np.random.beta(a, b)`**：这个函数从参数为 `a` 和 `b` 的 Beta 分布中生成随机样本。`a` 和 `b` 是 Beta 分布的两个形状参数，通常称为α（alpha）和β（beta）。
  
### Beta 分布的性质：
1. **形状参数**：
   - **`a`（α）**：控制曲线的左侧形状。如果 `a > 1`，曲线在左侧更陡峭。
   - **`b`（β）**：控制曲线的右侧形状。如果 `b > 1`，曲线在右侧更陡峭。
   
2. **用途**：
   - 当 `a = 1` 且 `b = 1` 时，Beta 分布是一个均匀分布。
   - 当 `a > 1` 和 `b > 1` 时，分布会在中间集中。
   - 当 `a < 1` 和 `b < 1` 时，分布会在两端集中。

3. **应用场景**：
   - **贝叶斯推断**：Beta 分布常用作二项分布的共轭先验分布，特别是在处理成功概率的估计时。
   - **A/B 测试**：在 A/B 测试中，Beta 分布用于估计不同版本的成功率。

### 使用示例：
假设 `self._a` 和 `self._b` 是在某个上下文中定义的变量，表示特定 Beta 分布的形状参数，`np.random.beta(self._a, self._b)` 将根据这些参数生成一个在 0 到 1 之间的随机样本。

这个生成的样本可以用于模拟、蒙特卡洛方法或其他需要从 Beta 分布中取样的统计分析任务。



# todo

ucb Thompson